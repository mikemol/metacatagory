# Makefile Triangle Identity Architecture

## Overview

The Makefile triangle identity is the core validation architecture ensuring that the project's build automation stays synchronized across three interdependent vertices:

1. **Agda Exporter** (source of generative truth)
2. **Makefile** (checked-in, user-facing)
3. **Documentation Witness** (human-readable reference)

All three must agree in perfect alignment at all times.

## The Three Vertices

### Vertex 1: Agda Exporter
**Location:** `src/agda/Examples/ExporterMakefile.agda`

The Agda exporter is the **source of truth** for Makefile generation. It defines:
- Which targets exist
- What each target depends on
- What commands each target executes
- How targets are categorized (validators, generators, etc.)

This vertex is programmatic and can be updated to reflect architectural changes that ripple through the entire build system.

### Vertex 2: Makefile (Checked-in)
**Location:** `Makefile`

The human-facing Makefile that users interact with. Generated from the Agda exporter via:
```bash
make regen-makefile
# Which runs:
#   .local/agda --compile src/agda/Examples/ExporterMakefile.agda
#   cp Makefile.generated Makefile
```

This vertex is **derived** from Vertex 1 but is checked into git for:
- CI/CD systems that may not have Agda installed
- Users who want to see the actual Makefile rules
- Emergency manual edits (which must then propagate back to the exporter)

### Vertex 3: Makefile.generated
**Location:** `Makefile.generated`

Intermediate artifact produced by the Agda exporter. This is:
- Generated by `src/agda/ExporterMakefile` (compiled Agda program)
- Copied to `Makefile` via `cp Makefile.generated Makefile`
- Used for validation (must match checked-in `Makefile`)

### Vertex 4: Documentation Witness
**Location:** `docs/automation/MAKEFILE-TARGETS.md`

Human-readable table documenting every public target. Serves as:
- Specification of what targets should exist
- Witness for validation
- User-facing reference documentation

## The Triangle Validation

### Validation Rules

The triangle identity enforces six consistency checks:

| # | Check | Error | Resolution |
|---|-------|-------|-----------|
| 1 | Agda generator produces all documented targets | "Documented targets missing from Makefile.generated" | Update ExporterMakefile.agda |
| 2 | Makefile.generated ↔ Makefile phony (→) | "Phony targets missing from Makefile.generated" | Regenerate via `make regen-makefile` |
| 3 | Makefile.generated ↔ Makefile phony (←) | "Extra targets in Makefile.generated not in Makefile" | Regenerate via `make regen-makefile` |
| 4 | Makefile targets documented | "Phony targets missing in docs" | Add to MAKEFILE-TARGETS.md |
| 5 | Documentation targets in Makefile | "Documented targets not in Makefile phony" | Remove from MAKEFILE-TARGETS.md or add to Makefile |
| 6 | Phony targets have rules | "Phony targets without Makefile rule" | Add rule or remove from .PHONY |

### Validation Tool

**Location:** `scripts/validate_makefile_docs.py`

Run with:
```bash
python3 scripts/validate_makefile_docs.py
```

This performs all six checks and reports the status of all three vertices.

**Integrated into CI:** Run via `make makefile-validate` target.

## Workflow: Making Changes

### Case 1: Adding a New Target

Want to add a new Makefile target? Follow this order:

1. **Update the Agda exporter** (`src/agda/Examples/ExporterMakefile.agda`)
   - Add the new target to `discoveredTargets`
   - Specify its dependencies and commands
   
2. **Regenerate the Makefile**
   ```bash
   make regen-makefile
   ```
   This updates both `Makefile.generated` and `Makefile`.

3. **Update the witness documentation** (`docs/automation/MAKEFILE-TARGETS.md`)
   - Add a row to the targets table
   - Document purpose and notes

4. **Validate the triangle**
   ```bash
   python3 scripts/validate_makefile_docs.py
   ```
   Should report: `Status: ✓ OK - All three vertices agree`

5. **Commit all three vertices**
   ```bash
   git add Makefile src/agda/Examples/ExporterMakefile.agda docs/automation/MAKEFILE-TARGETS.md
   git commit -m "feat: add new target <name>"
   ```

### Case 2: Fixing a Target's Commands

The commands for an existing target need updating:

1. **Update the Agda exporter** (the source of truth)
   ```agda
   validatorToTarget "target-name" "output/path"
     ("command line 1" ∷ "command line 2" ∷ [])
   ```

2. **Regenerate**
   ```bash
   make regen-makefile
   ```

3. **Validate**
   ```bash
   python3 scripts/validate_makefile_docs.py
   ```

4. **Commit both vertices**
   ```bash
   git add Makefile src/agda/Examples/ExporterMakefile.agda
   git commit -m "fix: update target-name commands"
   ```

### Case 3: Emergency Manual Makefile Edit (Last Resort)

If you must edit `Makefile` directly:

1. Edit `Makefile` manually
2. **Copy the changes back to the exporter** (`src/agda/Examples/ExporterMakefile.agda`)
3. **Regenerate to verify**
   ```bash
   make regen-makefile
   # Should produce identical Makefile
   ```
4. **Validate**
   ```bash
   python3 scripts/validate_makefile_docs.py
   ```

This ensures the exporter stays in sync with reality.

## Design Rationale

### Why Three Vertices?

1. **Agda Exporter**: Enables programmatic generation and validation. Supports complex logic, transformations, and architecture enforcement at the source.

2. **Makefile**: Users and CI systems need the actual runnable Makefile, independent of Agda availability.

3. **Documentation**: Humans need a reference. Forces explicit declaration of intent and helps catch mistakes.

### Why Validate?

The triangle identity ensures:
- **Consistency**: All downstream artifacts stay in sync with the source
- **Single Source of Truth**: The Agda exporter is authoritative
- **Traceability**: Changes flow through all three vertices
- **Recoverability**: If one vertex diverges, validation catches it immediately
- **Reviewability**: Changes to build automation are explicit and traceable through git

### Why Not Just One Vertex?

- **Agda only**: CI systems need pre-built Makefiles
- **Makefile only**: No programmatic generation, manual maintenance of 100+ targets, high error rate
- **Documentation only**: Divorced from actual implementation, loses authority

The triangle balances automation, accessibility, and human oversight.

## Integration Points

The triangle validation is integrated into the CI/CD pipeline:

- **Makefile target**: `make makefile-validate` (runs validation, writes report)
- **CI workflow**: Run in GitHub Actions as part of "Typecheck and Docs" workflow
- **Check target**: `make check` depends on `makefile-validate`

This prevents broken triangles from being committed.

## Examples of Triangle Alignment

### Example 1: Markdown Linting Tool Change

**Scenario**: Switch from `remark` to `markdownlint-cli2`

**Changes across three vertices**:

1. **Agda Exporter** (`ExporterMakefile.agda`):
   ```agda
   validatorToTarget "md-lint" "build/reports/md-lint.txt"
     ("npx markdownlint-cli2 \"**/*.md\" \"!node_modules\" \"!build\" > build/reports/md-lint.txt 2>&1 || true" ∷ [])
   ```

2. **Makefile** (generated and checked-in):
   ```makefile
   md-lint:
     npx markdownlint-cli2 "**/*.md" "!node_modules" "!build" > build/reports/md-lint.txt 2>&1 || true
   ```

3. **Documentation** (`MAKEFILE-TARGETS.md`):
   ```markdown
   | `md-lint` | Lint Markdown | markdownlint-cli2 across repo; outputs to build/reports/md-lint.txt |
   ```

All three vertices now consistently reference the new tool.

### Example 2: CI Directory Creation

**Scenario**: `makefile-validate` fails in CI because `build/reports/` doesn't exist

**Triangle correction**:

1. **Agda Exporter**:
   ```agda
   validatorToTarget "makefile-validate" "build/reports/makefile-validate.txt"
     ("mkdir -p build/reports" ∷ "python3 scripts/validate_makefile_docs.py > build/reports/makefile-validate.txt" ∷ [])
   ```

2. **Makefile** (after regeneration):
   ```makefile
   makefile-validate:
     mkdir -p build/reports
     python3 scripts/validate_makefile_docs.py > build/reports/makefile-validate.txt
   ```

3. **Documentation**: (no change needed, already documented that it outputs to `build/reports/makefile-validate.txt`)

Now all systems create the directory before writing, triangle stays in sync.

## Validation Status

Run `python3 scripts/validate_makefile_docs.py` to see the current status:

```
Makefile triangle identity validation
==================================================

Triangle vertices:
  1) Agda exporter → Makefile.generated (source of truth)
  2) Makefile.generated → Makefile (copied)
  3) Makefile ↔ docs/automation/MAKEFILE-TARGETS.md (witness)

Status: ✓ OK - All three vertices agree
```

If any vertex shows discrepancies, the validation report identifies exactly which vertex is out of sync and what needs to be corrected.
