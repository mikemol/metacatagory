# Roadmap Semantic Enrichment Pipeline

Extracts semantic details from roadmap source materials and associates them with tasks using Agda's native dependency tracking.

## Architecture

    Source Materials → Canonical Merge → Semantic Enrichment → Exports
                                          ↑
                                          Agda Dependency Graph

### Components

1. **Merge** (`scripts/merge_roadmaps.py`)
    * Inputs: `.github/roadmap/tasks.json`, `ROADMAP.md`, ingested GP files, testing.md
    * Output: `build/canonical_roadmap.json` (102 items with provenance)

2. **Agda Dependency Graph** (generated by Agda)
    * Command: `agda --dependency-graph=build/diagrams/agda-deps-full.dot -i src/agda src/agda/Tests/Index.agda`
    * Output: `build/diagrams/agda-deps-full.dot` (116 modules, 221 edges)
    * Authoritative source for module import relationships

3. **Enrichment** (`scripts/enrich_canonical.py`)
    * Reads: `build/canonical_roadmap.json`, `build/diagrams/agda-deps-full.dot`
    * Extracts:
        * **Evidence**: Markdown sections, Agda doc comments
        * **Intent**: Why (from evidence + heuristics)
        * **Deliverable**: What artifact/behavior
        * **Scope**: In/out boundaries
        * **Acceptance**: Checklist with extracted definitions
        * **Dependencies**: Suggested from Agda import graph
        * **Tags**: Normalized vocabulary
        * **Module anchors**: Agda module names
        * **Definitions**: Top-level names from Agda files
    * Output: `build/canonical_enriched.json` (102 items, 29 suggested deps)

4. **Exports**
    * **Markdown digest** (`scripts/export_enriched_md.py`)
        * Output: `build/reports/tasks_enriched.md` (4369 lines)
        * Human-readable with all semantic fields
    * **Dependency graphs** (`scripts/export_dependency_graph.py`)
        * Outputs: `build/reports/dependency_graph.{mmd,dot}`
        * Mermaid flowchart + GraphViz DOT with status coloring

## Workflow

```bash
# 1. Generate Agda dependency graph (run once or when imports change)
agda --dependency-graph=build/diagrams/agda-deps-full.dot -i src/agda src/agda/Tests/Index.agda

# 2. Merge roadmap sources
make roadmap-merge

# 3. Enrich with semantic details (uses agda-deps-full.dot)
make roadmap-enrich

# 4. Export human-readable reports
make roadmap-export-enriched roadmap-export-deps

# 5. Validate triangle consistency
make roadmap-validate-triangle
```

### Quick rebuild

```bash
make roadmap-merge roadmap-enrich roadmap-export-enriched roadmap-export-deps
```

## Key Design Decisions

### Why use Agda's --dependency-graph instead of parsing imports?

1. **Authoritative**: Agda tracks dependencies accurately, handling:
    * Re-exports
    * Implicit imports from open statements
    * Parameterized modules
    * Instance arguments

2. **Consistent**: Same dependency information used by:
    * Makefile generation (`src/agda/Examples/ExporterMakefile.agda`)
    * Build system (`.agdai` interface files)
    * Enrichment pipeline (this system)

3. **Efficient**: Agda already computes the graph; we reuse it rather than re-parse

### Module-to-task mapping

Maps module names (e.g., `Core.Yoneda`) to task IDs (e.g., `PHASE-IV.2`).
Used to translate module dependencies → task dependencies.

Example:

* `Tests.YonedaChecklist` imports `Algebra.Rings.Basic`
* `Algebra.Rings.Basic` appears in `INGEST-Ch3-Ideals-Lattice`
* → Suggest `PHASE-IV.2` depends on `INGEST-Ch3-Ideals-Lattice`

## Statistics (current)

* **Total tasks**: 102
* **Modules tracked**: 116
* **Dependency edges**: 221
* **Suggested dependencies**: 29 (across 6 tasks)
* **Most depended-on**:
  * `PHASE-0.1`, `PHASE-0.2`, `PHASE-III.4`, `PHASE-III.5`, `PHASE-IV.1` (3 each)

## Output Artifacts

| File | Lines | Description |
|------|-------|-------------|
| `build/canonical_roadmap.json` | ~2K | Merged canonical roadmap |
| `build/canonical_enriched.json` | ~4.6K | With semantic fields |
| `build/reports/tasks_enriched.md` | 4369 | Human-readable digest |
| `build/reports/dependency_graph.mmd` | 146 | Mermaid flowchart |
| `build/reports/dependency_graph.dot` | 152 | GraphViz DOT |

## Future Enhancements

1. **Definition-level dependencies**: Parse `.agdai` interface files to extract which theorems use which lemmas
2. **Proof obligation tracking**: Link tasks to specific admitted/postulated holes
3. **Cross-reference network**: Build citation graph from docstrings
4. **Complexity metrics**: Analyze proof sizes, term depths from interface files
