#!/usr/bin/env python3
"""
Normalize generated markdown files with markdownlint.

This ensures all Agda/Python-generated markdown files comply with
the project's markdown style guide.
"""

import subprocess
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).parent.parent

# Files generated by Agda or Python that should be normalized
GENERATED_FILES = [
    "README.md",
    "CONTRIBUTING.md",
    "docs/NAVIGATION.md",
    "docs/planning/ROADMAP.md",
    "docs/status/DEFERRED-TRACKING.md",
    "docs/status/deferred-items.md",
    "docs/architecture/FRAMEWORK-INTEROPERABILITY.md",
    "docs/process/QUALITY-FRAMEWORK.md",
    "build/reports/tasks_enriched.md",
    "build/reports/test-report.md",
]


def normalize_markdown(filepath: Path) -> bool:
    """Run markdownlint --fix on a file."""
    if not filepath.exists():
        print(f"⚠️  Skipping {filepath} (does not exist)")
        return True
    
    try:
        result = subprocess.run(
            ["npx", "markdownlint-cli2", "--fix", str(filepath)],
            cwd=REPO_ROOT,
            capture_output=True,
            text=True,
        )
        
        if result.returncode == 0:
            print(f"✓ Normalized {filepath}")
            return True
        else:
            print(f"✗ Failed to normalize {filepath}")
            print(result.stdout)
            print(result.stderr)
            return False
    except Exception as e:
        print(f"✗ Error normalizing {filepath}: {e}")
        return False


def main():
    """Normalize all generated markdown files."""
    print("Normalizing generated markdown files...")
    print()
    
    success_count = 0
    total_count = 0
    
    for file_path in GENERATED_FILES:
        total_count += 1
        abs_path = REPO_ROOT / file_path
        if normalize_markdown(abs_path):
            success_count += 1
    
    print()
    print(f"Normalized {success_count}/{total_count} files")
    
    if success_count < total_count:
        sys.exit(1)


if __name__ == "__main__":
    main()
